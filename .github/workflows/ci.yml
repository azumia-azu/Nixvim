name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

permissions:
  contents: read

jobs:
  flake:
    name: Nix flake checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 安装 Nix（稳定、推荐）
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      # 启用官方公共缓存 + 可选加速
      - name: Enable Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      # 运行 flake check（会做：eval、tests、nix fmt/linters(如果你定义了)、部分 build）
      - name: Flake check
        run: nix flake check -L

      # 如果你仓库有 packages 输出，顺手 build 一下 default（没有也不会失败）
      - name: Build default package (if exists)
        run: |
          set -euo pipefail
          if nix flake show --json | jq -e '.packages?["x86_64-linux"]?["default"]? // empty' >/dev/null; then
            nix build -L .#packages.x86_64-linux.default
          else
            echo "No packages.x86_64-linux.default, skip."
          fi
        shell: bash

  # 可选：在 macOS 上也跑 eval/check（更慢，但能抓到 Darwin 兼容性问题）
  flake-macos:
    name: Nix flake checks (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v13
      - uses: DeterminateSystems/magic-nix-cache-action@v7
      - run: nix flake check -L
